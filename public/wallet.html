<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wallet Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --brand:#0066ff; --bg:#f8fafc; --text:#111827; --muted:#6b7280; --card:#ffffff; --border:#e5e7eb; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin:0; font-family:'Inter', system-ui, -apple-system, sans-serif; background-color: var(--bg); color: var(--text); }
    .app { max-width: 900px; margin: 0 auto; min-height: 100%; padding: 1rem; opacity:0; transform: translateY(4px); transition: opacity .18s ease, transform .18s ease; }
    .ready .app { opacity: 1; transform: none; }
    .leaving .app { opacity: 0; transform: translateY(4px); }
    .header { position: sticky; top:0; background: var(--bg); border-bottom:1px solid var(--border); z-index: 20; }
    .header-inner { display:flex; align-items:center; justify-content:space-between; padding: 0.75rem 0; }
    .title { font-weight: 700; font-size: 1.25rem; }

    .grid { display:grid; grid-template-columns: 1fr; gap: 1rem; }
    @media (min-width: 860px) { .grid { grid-template-columns: 1fr 1fr; }}

    .card { background: var(--card); border:1px solid var(--border); border-radius: 16px; padding: 1rem; box-shadow: 0 1px 0 rgba(0,0,0,0.04); }
    .label { color:var(--muted); font-size:0.85rem; }
    .row { display:flex; gap:0.75rem; align-items:center; flex-wrap: wrap; }

    .btn { padding: 0.5rem 0.75rem; border-radius: 10px; border:1px solid transparent; background: var(--brand); color: #ffffff; font-weight: 600; font-size: 0.9rem; cursor:pointer; transition: background-color .15s ease, box-shadow .15s ease, filter .15s ease; }
    .btn:hover { filter: brightness(0.95); }
    .btn:active { filter: brightness(0.9); }
    .btn:focus-visible { outline: 2px solid var(--brand); outline-offset: 2px; }

    .input { border:1px solid var(--border); border-radius:12px; padding:0.5rem 0.75rem; font-size:0.95rem; }
    .muted { color: var(--muted); }

    .kpis { display:grid; grid-template-columns: repeat(3,1fr); gap: 0.75rem; }
    .kpi { background: var(--card); border:1px solid var(--border); border-radius: 14px; padding: 0.75rem; }
    .kpi .value { font-size: 1.2rem; font-weight: 700; }

    /* charts */
    .chart-wrap { background: var(--card); border:1px solid var(--border); border-radius: 16px; padding: 1rem; }

    /* dark mode */
    .dark { --brand:#60a5fa; --bg:#0b1220; --text:#e5e7eb; --muted:#9ca3af; --card:#111827; --border:#1f2937; }
    .dark .card, .dark .chart-wrap { background: var(--card); border-color: var(--border); }

    /* Top section responsiveness */
    .header-inner { gap:.5rem; flex-wrap: wrap; }
    .header-actions { display:flex; gap:.5rem; align-items:center; flex-wrap: wrap; }
    .prefs-toggle { display:none; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; }

    /* Responsive utilities and filters */
    .filters { display:flex; gap:8px; margin-top:.5rem; flex-wrap:wrap; }
    .filter { padding:6px 10px; border-radius:999px; border:1px solid var(--border); background: var(--card); color: var(--text); cursor:pointer; font-size:.85rem; }
    .filter.active { background: var(--brand); color:#fff; border-color: var(--brand); }

    .tx-list { margin-top:.5rem; }
    .tx-row { display:grid; grid-template-columns: 90px 100px 60px 1fr 110px; gap:8px; padding:8px 0; border-bottom:1px solid var(--border); }
    .tx-row .mono { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .tx-row .amount { text-align:right; font-weight:600; }

    .btn-secondary { padding: 0.5rem 0.75rem; border-radius: 10px; border:1px solid var(--border); background: var(--card); color: var(--text); font-weight:600; cursor:pointer; display: inline-flex; align-items: center; justify-content: center; }
    .btn-secondary:hover { filter: brightness(0.97); }
    .btn-secondary:focus-visible { outline: 2px solid var(--brand); outline-offset: 2px; }
    .btn-secondary svg { width: 20px; height: 20px; stroke-width: 2; }
    
    /* Icon button specific styling */
    #backBtn { min-width: 44px; min-height: 44px; padding: 0.75rem; }
    #togglePrefs { min-width: 44px; min-height: 44px; padding: 0.75rem; }

    .tx-actions { display:flex; justify-content:flex-end; margin-top:.5rem; }

    @media (max-width: 520px) {
      .prefs-toggle { display:inline-flex; }
      #headerPrefs { display:none; }
      #headerPrefs.open { display:flex; }
      .title { font-size: clamp(1rem, 4vw, 1.25rem); }
      .input { width: 100%; }
      .tx-row { grid-template-columns: 80px 1fr 110px; }
      .tx-row .hide-sm { display:none; }
    }
    /* Responsive utilities */
    .hide-sm { display: none; }
    @media (min-width: 641px){ .hide-sm { display: initial; } }

    /* Layout scalability */
    .chart-wrap { min-width: 0; }
    .chart-wrap canvas { width: 100% !important; height: auto !important; }
    .kpis { grid-template-columns: repeat(3, 1fr); }
    @media (max-width: 860px){ .kpis { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 480px){ .kpis { grid-template-columns: 1fr; } }

    /* Transaction list responsive grid */
    .tx-row { grid-template-columns: 90px 100px 60px 1fr 110px; }
    @media (max-width: 860px){ .tx-row { grid-template-columns: 80px 1fr 110px; } }
    @media (max-width: 640px){ .tx-row { grid-template-columns: 74px 1fr 96px; } }

    /* Card and app padding for small screens */
    @media (max-width: 640px){ .card { padding: 0.75rem; } .app { padding: 0.75rem; } }

    /* Header actions wrap and spacing */
    .header-inner { gap: .5rem; flex-wrap: wrap; }
    .header-actions { gap: .5rem; flex-wrap: wrap; }

    /* Bottom Nav */
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; align-items: center; background-color: white; padding: 0.75rem 1rem; z-index: 10; max-width: 390px; margin: 0 auto; border-top: 1px solid var(--border); }
    .bottom-nav-item { display:flex; flex-direction:column; align-items:center; justify-content:center; color:#9ca3af; position:relative; text-decoration:none; }
    .bottom-nav-item.active { color: var(--brand); }
    .bottom-nav-text { font-size: 0.75rem; }
    .bottom-nav-indicator { position: absolute; bottom: -12px; left: 0; right: 0; margin: 0 auto; width: 24px; height: 2px; background-color: var(--brand); }
    .dark .bottom-nav { background-color: var(--card); border-top-color: var(--border); }
    @media (min-width: 640px){ .bottom-nav, .bottom-bar { max-width: 640px; } }
    @media (min-width: 860px){ .bottom-nav, .bottom-bar { max-width: 900px; } }
  </style>
</head>
<body>
  <script>document.documentElement.classList.add('dark');</script>
  <div class="app">
    <div class="header">
      <div class="header-inner">
        <div class="row">
          <button id="backBtn" class="btn-secondary" aria-label="Go back">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m12 19-7-7 7-7"></path>
              <path d="m19 12H5"></path>
            </svg>
          </button>
          <div class="title">Wallet Tracker</div>
        </div>
        <div id="headerPrefs" class="header-actions">
          <input id="etherscanKey" class="input" placeholder="Etherscan API Key (optional)" style="width: clamp(180px, 40vw, 320px)" />
          <button id="saveKey" class="btn">Save Key</button>
        </div>
        <button id="togglePrefs" class="btn-secondary prefs-toggle" aria-controls="headerPrefs" aria-expanded="false">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83 2.83l.06-.06a1.65 1.65 0 0 0-.33 1.82V9c0 .66.26 1.3.73 1.77s1.11.73 1.77.73H21a2 2 0 0 1 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
          </svg>
        </button>
        <a href="notifications.html" class="btn-secondary" title="Alerts" aria-label="Alerts">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8a6 6 0 10-12 0c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 01-3.46 0"></path></svg>
        </a>
        <a href="settings.html" class="btn-secondary" title="Settings" aria-label="Settings" style="display:none">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83 2.83l.06-.06a1.65 1.65 0 0 0-.33 1.82V9c0 .66.26 1.3.73 1.77s1.11.73 1.77.73H21a2 2 0 0 1 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </a>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="label">Connection</div>
        <div id="connStatus" class="muted">Not connected</div>
        <div class="row" style="margin-top: 0.75rem">
          <button id="connectBtn" class="btn">Connect Wallet</button>
          <div id="addr" class="mono"></div>
          <button id="copyAddr" class="btn-secondary">Copy</button>
        </div>
        <div class="row" style="margin-top: 0.75rem">
          <div>Chain: <span id="chain">—</span></div>
          <div style="margin-left: 1rem">Balance: <span id="balance">—</span> ETH</div>
        </div>
      </div>

      <div class="card">
        <div class="label">KPIs</div>
        <div class="kpis" style="margin-top: 0.5rem">
          <div class="kpi"><div class="muted">Weekly Income</div><div class="value" id="kpiWeeklyIncome">—</div></div>
          <div class="kpi"><div class="muted">Weekly Spending</div><div class="value" id="kpiWeeklySpending">—</div></div>
          <div class="kpi"><div class="muted">Monthly Net</div><div class="value" id="kpiMonthlyNet">—</div></div>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top: 1rem">
      <div class="chart-wrap">
        <div class="label" style="margin-bottom: .5rem">Weekly Breakdown (Income vs Spending)</div>
        <canvas id="weeklyChart" height="160"></canvas>
      </div>
      <div class="chart-wrap">
        <div class="label" style="margin-bottom: .5rem">Monthly Net and Totals</div>
        <canvas id="monthlyChart" height="160"></canvas>
      </div>
    </div>

    <div class="chart-wrap" style="margin-top: 1rem">
      <div class="label" style="margin-bottom: .5rem">Income vs Spending Share</div>
      <canvas id="breakdownChart" height="160"></canvas>
    </div>

    <div class="card" style="margin-top: 1rem">
      <div class="label">Recent Transactions</div>
      <div id="txFilters" class="filters">
        <button class="filter active" data-filter="all">All</button>
        <button class="filter" data-filter="income">Income</button>
        <button class="filter" data-filter="spending">Spending</button>
      </div>
      <div id="txList" class="tx-list" style="max-height: 420px; overflow: auto;"></div>
      <div class="tx-actions">
        <button id="loadMoreTx" class="btn-secondary">Load More</button>
      </div>
    </div>
  </div>

  <nav class="bottom-nav">
    <a href="overview.html" class="bottom-nav-item" aria-label="Home">
      <span class="bottom-nav-text">Home</span>
    </a>
    <a href="projects.html" class="bottom-nav-item" aria-label="Projects">
      <span class="bottom-nav-text">Projects</span>
    </a>
    <a href="pal.html" class="bottom-nav-item" aria-label="PAL">
      <span class="bottom-nav-text">Pal</span>
    </a>
    <a href="wallet.html" class="bottom-nav-item active" aria-label="Wallet">
      <span class="bottom-nav-text">Wallet</span>
      <div class="bottom-nav-indicator"></div>
    </a>
    <a href="notifications.html" class="bottom-nav-item" aria-label="Alerts">
      <span class="bottom-nav-text">Alerts</span>
    </a>
  </nav>

  <script>
    const state = { address: null, chainId: null, balanceEth: null, txs: [], txFilter: 'all', txVisible: 30 };

    function fmtEth(weiHex){
      try{ const wei = BigInt(weiHex); const eth = Number(wei) / 1e18; return (Math.round(eth*1000)/1000).toString(); }catch(e){ return '0'; }
    }
    function fmtCurrency(n){ return '$' + (n<0 ? '-' : '') + Math.abs(n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }

    function saveApiKey(){ const key = document.getElementById('etherscanKey').value.trim(); localStorage.setItem('ETHERSCAN_API_KEY', key); }
    function loadApiKey(){ const key = localStorage.getItem('ETHERSCAN_API_KEY')||''; document.getElementById('etherscanKey').value = key; return key; }

    async function connect(){
      if(!window.ethereum){ document.getElementById('connStatus').textContent = 'No Ethereum provider found (install MetaMask)'; return; }
      try{
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const address = accounts[0];
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        const balance = await window.ethereum.request({ method: 'eth_getBalance', params: [address, 'latest'] });
        state.address = address; state.chainId = chainId; state.balanceEth = fmtEth(balance);
        document.getElementById('connStatus').textContent = 'Connected';
        document.getElementById('addr').textContent = address;
        document.getElementById('chain').textContent = chainId;
        document.getElementById('balance').textContent = state.balanceEth;
        await loadTransactions();
      }catch(e){ console.error(e); document.getElementById('connStatus').textContent = 'Connection failed'; }
    }

    async function fetchEtherscan(address){
      const key = loadApiKey();
      const base = 'https://api.etherscan.io/api';
      const url = `${base}?module=account&action=txlist&address=${address}&startblock=0&endblock=99999999&sort=desc${key?`&apikey=${key}`:''}`;
      const res = await fetch(url);
      const data = await res.json();
      if(data && data.status === '1') return data.result;
      throw new Error('Etherscan fetch failed');
    }

    function mockTransactions(address){
      const now = Date.now(); const day = 24*3600*1000;
      const makeTx = (ts, from, to, valueEth) => ({ timeStamp: Math.floor(ts/1000).toString(), from, to, value: (BigInt(Math.round(valueEth*1e18))).toString() });
      const me = address || '0xYourAddress';
      const other = '0xOther';
      const txs = [];
      for(let i=1;i<=60;i++){
        const ts = now - i*day;
        const incoming = i%3===0; const amount = incoming ? (0.02 + (i%5)*0.005) : (0.015 + (i%4)*0.004);
        txs.push(makeTx(ts, incoming? other : me, incoming? me : other, amount));
      }
      return txs;
    }

    const API_BASE = 'http://127.0.0.1:8012';

    async function syncTransactions(){
      try{
        const res = await fetch(`${API_BASE}/api/transactions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ address: state.address || '0xYourAddress', transactions: state.txs || [] })
        });
        const data = await res.json();
        if(data && data.kpis){
          const k = data.kpis;
          const W = document.getElementById('kpiWeeklyIncome');
          const S = document.getElementById('kpiWeeklySpending');
          const M = document.getElementById('kpiMonthlyNet');
          if(W) W.textContent = fmtCurrency(k.weeklyIncome);
          if(S) S.textContent = fmtCurrency(k.weeklySpending);
          if(M) M.textContent = fmtCurrency(k.monthlyNet);
        }
      }catch(e){ console.warn('Backend sync failed', e); }
    }
    async function loadTransactions(){
      if(!state.address){ state.txs = mockTransactions(); await syncTransactions(); render(); return; }
      try{
        const txs = await fetchEtherscan(state.address);
        state.txs = txs;
      }catch(e){ console.warn('Using mock transactions', e); state.txs = mockTransactions(state.address); }
      await syncTransactions();
      render();
    }

    function weiToEth(valueStr){ try{ return Number(BigInt(valueStr)) / 1e18; }catch(e){ return 0; } }

    function categorizeAndAggregate(txs, address){
      const weekly = {}; // { weekStartISO: { income, spending } }
      const monthly = {}; // { monthKey: { income, spending } }
      let totalIncome = 0, totalSpending = 0;
      txs.forEach(tx => {
        const ts = Number(tx.timeStamp)*1000; const d = new Date(ts);
        const weekStart = new Date(d); const day = weekStart.getDay(); weekStart.setDate(weekStart.getDate()-day); weekStart.setHours(0,0,0,0);
        const weekKey = weekStart.toISOString().slice(0,10);
        const monthKey = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        const amount = weiToEth(tx.value);
        const income = tx.to && tx.to.toLowerCase() === address.toLowerCase();
        const spending = tx.from && tx.from.toLowerCase() === address.toLowerCase();
        const cat = income ? 'income' : (spending ? 'spending' : null);
        if(!cat) return;
        weekly[weekKey] = weekly[weekKey] || { income:0, spending:0 };
        monthly[monthKey] = monthly[monthKey] || { income:0, spending:0 };
        weekly[weekKey][cat] += amount;
        monthly[monthKey][cat] += amount;
        if(cat==='income') totalIncome += amount; else totalSpending += amount;
      });
      return { weekly, monthly, totals: { income: totalIncome, spending: totalSpending } };
    }

    function computeKpis(agg){
      const weeks = Object.keys(agg.weekly).sort();
      const months = Object.keys(agg.monthly).sort();
      const lastWeek = weeks[weeks.length-1];
      const lastMonth = months[months.length-1];
      const weeklyIncome = lastWeek ? agg.weekly[lastWeek].income : 0;
      const weeklySpending = lastWeek ? agg.weekly[lastWeek].spending : 0;
      const monthlyNet = lastMonth ? (agg.monthly[lastMonth].income - agg.monthly[lastMonth].spending) : 0;
      return { weeklyIncome, weeklySpending, monthlyNet };
    }

    function renderCharts(agg){
      const isDark = document.documentElement.classList.contains('dark');
      const grid = isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)';
      const tick = isDark ? '#cbd5e1' : '#374151';

      const wkeys = Object.keys(agg.weekly).sort();
      const wIncome = wkeys.map(k=>agg.weekly[k].income);
      const wSpend = wkeys.map(k=>agg.weekly[k].spending);
      const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
      if(window._weeklyChart) window._weeklyChart.destroy();
      window._weeklyChart = new Chart(weeklyCtx, {
        type: 'line',
        data: {
          labels: wkeys.map(k=>k.slice(5)),
          datasets: [
            { label:'Income', data:wIncome, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.12)', borderWidth:2, pointRadius:2, fill:true },
            { label:'Spending', data:wSpend, borderColor:'#ef4444', backgroundColor:'rgba(239,68,68,0.12)', borderWidth:2, pointRadius:2, fill:false, borderDash:[6,4] }
          ]
        },
        options: {
          responsive:true,
          interaction:{ mode:'index', intersect:false },
          plugins:{ legend:{ labels:{ color: tick } }, tooltip:{ callbacks:{ label: (ctx)=> `${ctx.dataset.label}: ${fmtCurrency(ctx.parsed.y)}` } }, title:{ display:true, text:'Weekly (Income vs Spending)', color: tick, font:{ weight: 'bold' } } },
          scales:{ x:{ ticks:{ color: tick }, grid:{ color: grid } }, y:{ ticks:{ color: tick, callback:(v)=>fmtCurrency(v) }, grid:{ color: grid } } }
        }
      });

      const mkeys = Object.keys(agg.monthly).sort();
      const mIncome = mkeys.map(k=>agg.monthly[k].income);
      const mSpend = mkeys.map(k=>agg.monthly[k].spending);
      const mNet = mkeys.map((k,i)=>mIncome[i]-mSpend[i]);
      const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
      if(window._monthlyChart) window._monthlyChart.destroy();
      window._monthlyChart = new Chart(monthlyCtx, {
        type: 'bar',
        data: { labels: mkeys, datasets: [ { label:'Income', data:mIncome, backgroundColor:'rgba(16,185,129,0.6)' }, { label:'Spending', data:mSpend, backgroundColor:'rgba(239,68,68,0.6)' }, { label:'Net', data:mNet, type:'line', borderColor:'#2563eb', backgroundColor:'rgba(37,99,235,0.12)', borderWidth:3, pointRadius:2, fill:true } ] },
        options: { responsive:true, interaction:{ mode:'index', intersect:false }, plugins:{ legend:{ labels:{ color: tick } }, tooltip:{ callbacks:{ label: (ctx)=> `${ctx.dataset.label}: ${fmtCurrency(ctx.parsed.y)}` } }, title:{ display:true, text:'Monthly Net and Totals', color: tick, font:{ weight: 'bold' } } }, scales:{ x:{ ticks:{ color: tick }, grid:{ color: grid } }, y:{ ticks:{ color: tick, callback:(v)=>fmtCurrency(v) }, grid:{ color: grid } } } }
      });

      const breakdownCtx = document.getElementById('breakdownChart').getContext('2d');
      if(window._breakdownChart) window._breakdownChart.destroy();
      window._breakdownChart = new Chart(breakdownCtx, {
        type: 'doughnut',
        data: { labels:['Income','Spending'], datasets:[ { data:[agg.totals.income, agg.totals.spending], backgroundColor:['#10b981','#ef4444'] } ] },
        options: { plugins:{ legend:{ labels:{ color: tick } }, title:{ display:true, text:'Income vs Spending Share', color: tick, font:{ weight: 'bold' } } } }
      });
    }

    function renderTxList(txs, address){
      const el = document.getElementById('txList');
      if(!el) return;
      const filtered = txs.filter(tx=>{
        const income = tx.to && address && tx.to.toLowerCase() === address.toLowerCase();
        const spending = tx.from && address && tx.from.toLowerCase() === address.toLowerCase();
        if(state.txFilter === 'income') return income;
        if(state.txFilter === 'spending') return spending;
        return true;
      });
      const visible = filtered.slice(0, state.txVisible);
      const rows = visible.map(tx=>{
        const ts = Number(tx.timeStamp)*1000; const d = new Date(ts);
        const date = d.toISOString().slice(0,10);
        const amount = weiToEth(tx.value);
        const income = tx.to && address && tx.to.toLowerCase() === address.toLowerCase();
        const spending = tx.from && address && tx.from.toLowerCase() === address.toLowerCase();
        const cat = income ? 'Income' : (spending ? 'Spending' : 'Other');
        const dir = income ? 'In' : (spending ? 'Out' : '-');
        const counterparty = income ? (tx.from||'') : (tx.to||'');
        return `<div class="tx-row">
          <div class="muted">${date}</div>
          <div class="hide-sm" style="font-weight:600">${cat}</div>
          <div class="muted hide-sm">${dir}</div>
          <div class="mono">${counterparty}</div>
          <div class="amount" style="color:${income?'#10b981':'#ef4444'}">${amount.toFixed(4)} ETH</div>
        </div>`;
      }).join('');
      el.innerHTML = rows || '<div class="muted">No transactions</div>';
    }

    function render(){
      const agg = categorizeAndAggregate(state.txs, state.address||'0xYourAddress');
      const kpis = computeKpis(agg);
      document.getElementById('kpiWeeklyIncome').textContent = fmtCurrency(kpis.weeklyIncome);
      document.getElementById('kpiWeeklySpending').textContent = fmtCurrency(kpis.weeklySpending);
      document.getElementById('kpiMonthlyNet').textContent = fmtCurrency(kpis.monthlyNet);
      renderCharts(agg);
      renderTxList(state.txs, state.address||'0xYourAddress');
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.documentElement.classList.add('ready');
      try { localStorage.setItem('lastFeature','wallet'); } catch(e) {}
      document.getElementById('saveKey').addEventListener('click', saveApiKey);
      document.getElementById('connectBtn').addEventListener('click', connect);
      const backBtn = document.getElementById('backBtn');
      if(backBtn){
        backBtn.addEventListener('click', ()=>{
          document.documentElement.classList.add('leaving');
           setTimeout(()=>{
             if(history.length > 1) history.back(); else window.location.href = 'overview.html';
           }, 150);
        });
      }
      const toggle = document.getElementById('togglePrefs');
      const prefs = document.getElementById('headerPrefs');
      if(toggle && prefs){
        toggle.addEventListener('click', ()=>{
          const isOpen = prefs.classList.toggle('open');
          toggle.setAttribute('aria-expanded', String(isOpen));
        });
      }
      const copyBtn = document.getElementById('copyAddr');
      if(copyBtn){
        copyBtn.addEventListener('click', async ()=>{
          const addrEl = document.getElementById('addr');
          const text = addrEl?.textContent?.trim();
          if(text){
            try{ await navigator.clipboard.writeText(text); copyBtn.textContent='Copied'; setTimeout(()=>copyBtn.textContent='Copy',1500);}catch(e){}
          }
        });
      }
      const filtersEl = document.getElementById('txFilters');
      if(filtersEl){
        filtersEl.addEventListener('click', (e)=>{
          const btn = e.target.closest('button[data-filter]');
          if(!btn) return;
          state.txFilter = btn.dataset.filter;
          [...filtersEl.querySelectorAll('.filter')].forEach(b=>b.classList.toggle('active', b===btn));
          renderTxList(state.txs, state.address||'0xYourAddress');
        });
      }
      const loadMoreBtn = document.getElementById('loadMoreTx');
      if(loadMoreBtn){
        loadMoreBtn.addEventListener('click', ()=>{
          state.txVisible += 30;
          renderTxList(state.txs, state.address||'0xYourAddress');
        });
      }
      loadApiKey();
      loadTransactions();
    });
  </script>
</body>
</html>
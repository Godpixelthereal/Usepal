<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PAL – Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f8f9fa; margin: 0; padding: 0; }
    .app-container { max-width: 430px; margin: 0 auto; height: 100vh; background-color: white; position: relative; overflow: hidden; }
    .status-bar { display:flex; justify-content:space-between; padding:5px 15px; font-size:12px; background-color:white; }

    /* Increase top padding so chat sits below top icons */
    .chat-container { padding: 88px 16px 120px; height: calc(100vh - 120px); overflow-y: auto; }
    .message { max-width: 92%; margin-bottom: 16px; padding: 16px 18px; border-radius: 12px; font-size: 15px; line-height: 1.5; box-shadow: none; border: 1px solid rgba(0,0,0,0.04); }
    .user-message { margin-left: auto; background-color: #ffffff; color: #0f172a; }
    .pal-message { margin-right: auto; background-color: transparent; color: #111827; border: none; padding: 0; box-shadow: none; }

    /* Rich content within messages */
    .message p { margin: 0 0 0.75rem; }
    .message a { color: #2563eb; text-decoration: underline; }
    .message img { display:block; max-width: 100%; height: auto; border-radius: 10px; margin-top: 8px; }
    .message code { background: rgba(0,0,0,0.06); padding: 2px 6px; border-radius: 6px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 0.9em; }
    .message pre { background: #0b1220; color: #e5e7eb; padding: 12px; border-radius: 12px; overflow: auto; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .message .attachment { display:inline-flex; align-items:center; gap:8px; background: rgba(15,23,42,0.04); border: 1px solid rgba(0,0,0,0.06); border-radius: 9999px; padding: 8px 12px; margin: 6px 6px 0 0; text-decoration: none; color: inherit; }

    .typing-indicator { display:flex; align-items:center; gap:4px; }
    .typing-indicator span { width:6px; height:6px; border-radius:9999px; background:#9ca3af; display:inline-block; animation: blink 1.2s infinite; }
    .typing-indicator span:nth-child(2){ animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3){ animation-delay: 0.4s; }
    @keyframes blink { 0%, 80%, 100% { opacity: 0.2; } 40% { opacity: 1; } }

    .message-input-container { position: fixed; bottom: 64px; left: 0; right: 0; max-width: 430px; margin: 0 auto; padding: 10px 16px; background: transparent; }
    .message-input { flex: 1; min-width: 0; border: none; background: transparent; padding: 12px 14px; font-size: 14px; outline: none; }
    .send-button { width: 48px; height: 48px; margin-left: 8px; border-radius: 9999px; background: #0f172a; color: #fff; display:flex; align-items:center; justify-content:center; }

    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; align-items: center; background-color: white; padding: 0.75rem 1rem; z-index: 10; max-width: 430px; margin: 0 auto; border-top: 1px solid #f0f0f0; }
    .bottom-nav-item { display:flex; flex-direction:column; align-items:center; justify-content:center; color:#9ca3af; position:relative; text-decoration:none; }
    .bottom-nav-item.active { color:#0066ff; }
    .bottom-nav-icon { margin-bottom: 0.25rem; height: 24px; }
    /* Ensure SVG icons are sized and visible */
    .bottom-nav-icon svg { width: 24px; height: 24px; stroke-width: 2.5; }
    .bottom-nav-text { font-size: 0.75rem; }
    .bottom-nav-indicator { position: absolute; bottom: -12px; left: 0; right: 0; margin: 0 auto; width: 24px; height: 2px; background-color: #0066ff; }

    .points { position: fixed; top: calc(env(safe-area-inset-top, 0px) + 12px); right: 12px; background: white; border-radius: 9999px; padding: 8px 14px; display:flex; align-items:center; box-shadow: 0 4px 10px rgba(0,0,0,0.08); z-index: 20; }
    .profile { position: fixed; top: calc(env(safe-area-inset-top, 0px) + 12px); right: 12px; width: 40px; height: 40px; border-radius: 50% !important; background:white; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 10px rgba(0,0,0,0.08); z-index: 20; overflow:hidden; aspect-ratio: 1 / 1; }
    .top-actions { position: fixed; top: calc(env(safe-area-inset-top, 0px) + 12px); right: 12px; display:flex; gap:8px; z-index: 20; }
    .top-action { width: 40px; height: 40px; border-radius: 9999px; background:white; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 10px rgba(0,0,0,0.08); color:#0f172a; }
    .dark .top-action { background:#111827; color:#e5e7eb; box-shadow:none; }
    .profile img { width: 100%; height: 100%; object-fit: cover; border-radius: 50% !important; display:block; }
    .menu-floating { position: fixed; top: calc(env(safe-area-inset-top, 0px) + 12px); left: 12px; width: 44px; height: 44px; border-radius: 9999px; background:#EAF6FF; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 10px rgba(0,0,0,0.08); z-index: 20; cursor: pointer; transition: all 0.2s ease; color: #374151; }
    .menu-floating:hover { background:#D1E7FF; transform: scale(1.05); }
    .menu-floating:active { background:#B3D9FF; transform: scale(0.95); }
    .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 5px; background-color: #e5e7eb; z-index: 5; max-width: 430px; margin: 0 auto; }

    /* Side menu and dropdown styles */
    .menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 25; }
    .side-menu { position: fixed; top: 0; bottom: 0; left: 0; width: 320px; max-width: 85vw; background: #1e293b; color: #e2e8f0; box-shadow: 8px 0 24px rgba(0,0,0,0.2); z-index: 30; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
    .side-menu .menu-header { display:flex; align-items:center; }
    .menu-search-container { position: relative; width: 100%; }
    .menu-search { width: 100%; border-radius: 9999px; padding: 10px 12px 10px 40px; border: none; outline: none; background: #334155; color: #e2e8f0; }
    .menu-search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
    .menu-list { display:flex; flex-direction: column; gap: 8px; }
    .menu-item { display:flex; align-items:center; gap: 10px; border-radius: 12px; padding: 10px 12px; background: #334155; color: #e2e8f0; text-align:left; border: none; cursor: pointer; text-decoration: none; }
    .menu-item:hover { background: #475569; }
    .menu-section-title { color: #94a3b8; font-size: 12px; margin-top: 6px; }
    .menu-recent { display:flex; flex-direction:column; gap:8px; }
    .menu-footer { margin-top: auto; display:flex; flex-direction: column; background:#334155; border-radius:12px; padding: 12px; }
    .menu-credits { display:flex; align-items:center; justify-content:space-between; margin-bottom: 8px; color: #e2e8f0; }
    .menu-upgrade { font-size: 12px; color: #94a3b8; text-align: center; cursor: pointer; }
    .menu-upgrade:hover { color: #60a5fa; }

    .dropdown-menu { position: fixed; top: calc(env(safe-area-inset-top, 0px) + 60px); right: 12px; width: 240px; background: #111827; color: #e5e7eb; border-radius: 14px; box-shadow: 0 8px 24px rgba(0,0,0,0.25); z-index: 25; padding: 8px; }
    .dropdown-title { font-weight: 600; padding: 10px 12px; border-bottom: 1px solid #1f2937; margin-bottom: 6px; }
    .dropdown-item { width: 100%; text-align: left; padding: 10px 12px; border-radius: 10px; background: transparent; color: inherit; }
    .dropdown-item:hover { background: #1f2937; }
    .dropdown-item.destructive { color: #f87171; }

    /* ChatGPT-like mobile UI adjustments */
    .message-row { display:flex; align-items:flex-end; gap:12px; margin-bottom: 12px; }
    .message-row.user { justify-content:flex-end; }
    .message-row.pal { justify-content:flex-start; }
    .avatar { width: 44px; height: 44px; border-radius: 50% !important; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 10px rgba(0,0,0,0.08); overflow:hidden; aspect-ratio: 1 / 1; }
    .avatar.user { background:white; }
    .avatar.pal { background:#EAF6FF; color:#062D52; }
    .avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50% !important; display:block; }
    .timestamp { font-size: 12px; color:#1D4ED8; margin-left: 8px; margin-right: 8px; }

    .message-input-container { position: fixed; bottom: 72px; left: 0; right: 0; max-width: 430px; margin: 0 auto; padding: 10px 16px; background: transparent; }
    .composer-bar { display:flex; align-items:center; gap: 10px; background:#DDF1FF; border-radius: 9999px; padding: 8px 12px; }
    .composer-icon { width: 44px; height: 44px; border-radius: 9999px; background:#0f172a; color:#fff; display:flex; align-items:center; justify-content:center; }
    .mic-button { width: 44px; height: 44px; border-radius: 9999px; background:#0f172a; color:#fff; display:flex; align-items:center; justify-content:center; }

    .actions-sheet { position: fixed; left:0; right:0; bottom: 0; max-width: 430px; margin: 0 auto; padding: 16px; background: #E6F6FF; border-top-left-radius: 24px; border-top-right-radius: 24px; box-shadow: 0 -8px 24px rgba(0,0,0,0.08); z-index: 15; }
    .actions-grid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .action-card { border-radius: 20px; background:#fff; padding: 16px; height: 110px; display:flex; flex-direction:column; justify-content:flex-start; }
    .action-card.dark { background:#062D52; color:#fff; }
    .action-icon { width:32px; height:32px; border-radius:8px; border:2px solid #0066ff; color:#0066ff; display:flex; align-items:center; justify-content:center; margin-bottom: 12px; }
    .action-label { font-size: 14px; line-height: 1.2; }
    .hidden { display:none; }

    .attachment { display:flex; align-items:center; gap:8px; background:#E6F6FF; border-radius:14px; padding:8px 12px; }
    .attachment.doc { background:#E6F6FF; color:#062D52; }
    .attachment.doc span:first-child { width:32px; height:32px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; background:#062D52; color:#fff; }
    .attachment img { max-width: 80%; border-radius:12px; }
    .attachment-audio audio { width: 100%; }
      .action-card.dark .action-icon { border-color: #fff; color: #fff; }
      .voice-note { display:flex; align-items:center; gap:12px; background:#E6F6FF; border-radius:16px; padding:10px 12px; }
      .voice-play { width:40px; height:40px; border-radius:9999px; background:#062D52; color:#fff; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
      .voice-progress { flex:1; height:6px; background:#DCEBFF; border-radius:9999px; overflow:hidden; position:relative; }
      .voice-progress .fill { position:absolute; left:0; top:0; bottom:0; width:0%; background:#1D4ED8; }
      .voice-time { font-size:12px; color:#1D4ED8; min-width:44px; text-align:right; }

    /* Dark mode overrides */
    .dark body { background-color:#0b1220; color:#e5e7eb; }
    .dark .app-container { background-color:#0b1220; }
    .dark .status-bar { background-color:#0b1220; color:#e5e7eb; }
    .dark .chat-container { background-color:transparent; }
    .dark .message { border-color: rgba(255,255,255,0.08); }
    .dark .pal-message { background-color: transparent; color:#e5e7eb; border: none; padding: 0; box-shadow: none; }
    .dark .user-message { background-color:#0b1220; color:#e5e7eb; }
    .dark .message a { color:#93c5fd; }
    .dark .message code { background: rgba(255,255,255,0.08); }
    .dark .message pre { background:#0f172a; }
    .dark .message .attachment { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.08); }
    .dark .composer-bar { background-color:#111827; }
    .dark .message-input { color:#e5e7eb; }
    .dark .send-button { background:#2563eb; color:#fff; }
    .dark .mic-button, .dark .composer-icon { background:#2563eb; color:#fff; }
    .dark .bottom-nav { background-color:#111827; border-top-color:#1f2937; }
    .dark .bottom-bar { background-color:#1f2937; }
    .dark .points { background:#111827; color:#e5e7eb; box-shadow:none; }
    .dark .profile { background:#111827; }
    .dark .menu-floating { background:#1f2937; color:#e5e7eb; border: 1px solid #374151; }
    .dark .menu-floating:hover { background:#374151; border-color: #4b5563; transform: scale(1.05); }
    .dark .menu-floating:active { background:#4b5563; border-color: #6b7280; transform: scale(0.95); }
    .dark .actions-sheet { background:#0b1220; box-shadow:none; }
    .dark .action-card { background:#111827; color:#e5e7eb; }
    .dark .action-card.dark { background:#0f172a; color:#fff; }
    .dark .action-icon { border-color:#60a5fa; color:#60a5fa; }
    .dark .attachment { background:#111827; color:#e5e7eb; }
    .dark .voice-note { background:#111827; }
    .dark .voice-progress { background:#1f2937; }
    .dark .voice-progress .fill { background:#2563eb; }
    .dark .timestamp { color:#93c5fd; }
  </style>
</head>
<body>
  <script>document.documentElement.classList.add('dark');</script>
  <div class="app-container">

    <div class="menu-floating">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="5" y="7" width="14" height="2" rx="1" fill="currentColor"/>
        <rect x="5" y="11" width="14" height="2" rx="1" fill="currentColor"/>
        <rect x="5" y="15" width="14" height="2" rx="1" fill="currentColor"/>
      </svg>
    </div>

    <!-- Left-side menu drawer and overlay -->
    <div id="menuOverlay" class="menu-overlay hidden"></div>
    <div id="sideMenu" class="side-menu hidden" aria-label="Main menu">
      <div class="menu-header">
        <div class="menu-search-container">
          <svg class="menu-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
            <path d="m21 21-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <input id="menuSearch" class="menu-search" type="search" placeholder="Search" />
        </div>
      </div>
      <div class="menu-list">
        <button class="menu-item" id="menuNewChat">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 4V20M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          New chat
        </button>
        <a class="menu-item" href="projects.html">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M6.5 2H20V22H6.5A2.5 2.5 0 0 1 4 19.5V4.5A2.5 2.5 0 0 1 6.5 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Library
        </a>
        <a class="menu-item" href="assistant.html">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
            <circle cx="9" cy="9" r="2" stroke="currentColor" stroke-width="2"/>
            <path d="M21 15.5C21 15.5 18 12.5 15 12.5S9 15.5 9 15.5" stroke="currentColor" stroke-width="2"/>
          </svg>
          GPTs
        </a>
        <button class="menu-item" id="menuNewProject">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2H6A2 2 0 0 0 4 4V20A2 2 0 0 0 6 22H18A2 2 0 0 0 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <line x1="12" y1="18" x2="12" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="9" y1="15" x2="15" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          New project
        </button>
      </div>
      <div class="menu-section">
        <div class="menu-section-title">Recent chats</div>
        <div id="recentChats" class="menu-recent"></div>
      </div>
      <div class="menu-footer">
        <div class="menu-credits">
          <span>Credits</span>
          <span id="creditBalance">0</span>
        </div>
        <div class="menu-upgrade">Upgrade to Pro for more credits</div>
      </div>
    </div>

    <div class="top-actions" aria-label="Top actions">
      <button type="button" id="newChatAction" class="top-action" title="New chat" aria-label="New chat">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 5a2 2 0 0 1 2-2h10l4 4v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5z" stroke="currentColor" stroke-width="2"/>
          <path d="M9 15l6-6 2 2-6 6H9v-2z" fill="currentColor"/>
        </svg>
      </button>
      <button type="button" id="menuAction" class="top-action" title="More" aria-label="More options">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="6" r="2"/>
          <circle cx="12" cy="12" r="2"/>
          <circle cx="12" cy="18" r="2"/>
        </svg>
      </button>
    </div>

    <!-- Top-right dropdown menu for chat options -->
    <div id="chatMenu" class="dropdown-menu hidden" role="menu" aria-label="Chat options">
      <div class="dropdown-title" id="chatMenuTitle">Untitled chat</div>
      <button class="dropdown-item" data-action="share">Share</button>
      <button class="dropdown-item" data-action="rename">Rename</button>
      <button class="dropdown-item" data-action="add-to-project">Add to project</button>
      <button class="dropdown-item" data-action="archive">Archive</button>
      <button class="dropdown-item" data-action="delete">Delete</button>
      <button class="dropdown-item destructive" data-action="report">Report</button>
    </div>

    <div id="chat" class="chat-container"></div>
    <div id="suggestions" class="px-4 pb-2 flex gap-2 flex-wrap"></div>

    <form id="composer" class="message-input-container">
      <div class="composer-bar">
        <button id="toggleActions" type="button" class="composer-icon" aria-label="Open actions">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <circle cx="6" cy="12" r="2"/>
            <circle cx="12" cy="12" r="2"/>
            <circle cx="18" cy="12" r="2"/>
          </svg>
        </button>
        <input id="input" type="text" class="message-input" placeholder="Ask anything" />
        <button id="micBtn" type="button" class="mic-button" aria-label="Record audio">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 15a3 3 0 0 0 3-3V8a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3z" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M19 12a7 7 0 0 1-14 0" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M12 19v3" stroke="currentColor" stroke-width="2"/>
          </svg>
        </button>
        <button class="send-button" type="submit" aria-label="Send">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 11l18-8-8 18-2-7-8-3z" stroke="currentColor" stroke-width="2" fill="none"/>
          </svg>
        </button>
      </div>
    </form>

    <div id="actions" class="actions-sheet hidden">
      <div class="actions-grid">
        <button id="action-docs" type="button" class="action-card dark">
          <div class="action-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M6 3h8l5 5v13H6z" stroke="currentColor" stroke-width="2" fill="none"/>
              <path d="M14 3v6h6" stroke="currentColor" stroke-width="2" fill="none"/>
              <path d="M8 13h8M8 17h8" stroke="currentColor" stroke-width="2"/>
            </svg>
          </div>
          <div class="action-label">Attach new<br/>Documents</div>
        </button>
        <button id="action-photos" type="button" class="action-card">
          <div class="action-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="4" y="6" width="16" height="12" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
              <circle cx="9" cy="11" r="2" stroke="currentColor" stroke-width="2" fill="none"/>
              <path d="M20 17l-4-4-3 3-2-2-5 5" stroke="currentColor" stroke-width="2" fill="none"/>
            </svg>
          </div>
          <div class="action-label">Upload new<br/>Photos</div>
        </button>
        <button id="action-camera" type="button" class="action-card">
          <div class="action-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="4" y="7" width="16" height="12" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
              <path d="M9 7l2-3h2l2 3" stroke="currentColor" stroke-width="2" fill="none"/>
              <circle cx="12" cy="13" r="3" stroke="currentColor" stroke-width="2" fill="none"/>
            </svg>
          </div>
          <div class="action-label">Take direct<br/>Photos</div>
        </button>
        <button id="action-audio" type="button" class="action-card">
            <div class="action-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 15a3 3 0 0 0 3-3V8a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3z" stroke="currentColor" stroke-width="2" fill="none"/>
                <path d="M19 12a7 7 0 0 1-14 0" stroke="currentColor" stroke-width="2" fill="none"/>
                <path d="M12 19v3" stroke="currentColor" stroke-width="2"/>
              </svg>
            </div>
            <div class="action-label">Upload an<br/>Audio file</div>
          </button>
          <button id="action-invoice" type="button" class="action-card">
            <div class="action-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="5" y="3" width="14" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                <path d="M8 8h8M8 12h8M8 16h6" stroke="currentColor" stroke-width="2"/>
              </svg>
            </div>
            <div class="action-label">Generate new<br/>Invoice</div>
          </button>
          <button id="action-gen-image" type="button" class="action-card">
            <div class="action-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="4" y="6" width="16" height="12" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                <path d="M7 14l3-3 3 3 3-4 3 4" stroke="currentColor" stroke-width="2" fill="none"/>
              </svg>
            </div>
            <div class="action-label">Generate new<br/>Image</div>
          </button>
          <button id="action-more" type="button" class="action-card">
            <div class="action-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <circle cx="6" cy="12" r="2"/>
                <circle cx="12" cy="12" r="2"/>
                <circle cx="18" cy="12" r="2"/>
              </svg>
            </div>
            <div class="action-label">More<br/>actions</div>
          </button>
        <button id="action-report" type="button" class="action-card">
          <div class="action-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M4 18h16" stroke="currentColor" stroke-width="2"/>
              <rect x="6" y="10" width="3" height="6" fill="currentColor"/>
              <rect x="11" y="7" width="3" height="9" fill="currentColor"/>
              <rect x="16" y="12" width="3" height="4" fill="currentColor"/>
            </svg>
          </div>
          <div class="action-label">Check weekly<br/>Report</div>
        </button>
      </div>
      <input id="docInput" type="file" accept="application/pdf,.pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" multiple class="hidden"/>
      <input id="photoInput" type="file" accept="image/*" capture="environment" multiple class="hidden"/>
      <input id="audioInput" type="file" accept="audio/*" multiple class="hidden"/>
    </div>

    <nav class="bottom-nav">
      <a href="overview.html" class="bottom-nav-item" aria-label="Home">
        <div class="bottom-nav-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
        </div>
        <span class="bottom-nav-text">Home</span>
      </a>
      <a href="projects.html" class="bottom-nav-item" aria-label="Projects">
        <div class="bottom-nav-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM5 19V5H19V19H5Z" fill="currentColor"/>
            <path d="M7 7H17V9H7V7ZM7 11H17V13H7V11ZM7 15H14V17H7V15Z" fill="currentColor"/>
          </svg>
        </div>
        <span class="bottom-nav-text">Projects</span>
      </a>
      <a href="pal.html" class="bottom-nav-item active" aria-label="PAL">
        <div class="bottom-nav-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
        </div>
        <span class="bottom-nav-text">Pal</span>
        <div class="bottom-nav-indicator"></div>
      </a>
      <a href="wallet.html" class="bottom-nav-item" aria-label="Wallet">
        <div class="bottom-nav-icon">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="5" width="20" height="14" rx="2"></rect>
            <path d="M2 9h20"></path>
          </svg>
        </div>
        <span class="bottom-nav-text">Wallet</span>
      </a>
    </nav>

    <div class="bottom-bar"></div>
  </div>

    <div class="bottom-bar"></div>
  </div>

  <script src="js/pao.js"></script>
  <script>
    const chatEl = document.getElementById('chat');
    const inputEl = document.getElementById('input');
    const composerEl = document.getElementById('composer');
    const suggestionsEl = document.getElementById('suggestions');
    const actionsEl = document.getElementById('actions');
    const toggleActionsBtn = document.getElementById('toggleActions');
    const docInput = document.getElementById('docInput');
    const photoInput = document.getElementById('photoInput');
    const audioInput = document.getElementById('audioInput');
    const micBtn = document.getElementById('micBtn');

    // Credits system
    const pointsCountEl = document.querySelector('.points .font-bold');
    const loadCredits = () => {
      const raw = localStorage.getItem('palCredits');
      const n = parseInt(raw || '100', 10);
      return Number.isFinite(n) ? n : 100;
    };
    const isUnlimited = () => localStorage.getItem('palCreditsUnlimited') === 'true';
    let credits = loadCredits();
    const saveCredits = () => localStorage.setItem('palCredits', String(credits));
    const updateCreditsUI = () => { if (pointsCountEl) pointsCountEl.textContent = isUnlimited() ? '∞' : String(credits); };
    updateCreditsUI();
    const canCharge = (cost) => isUnlimited() || credits >= cost;
    const charge = (cost) => { if (isUnlimited()) return true; if (credits < cost) return false; credits -= cost; saveCredits(); updateCreditsUI(); return true; };
    const save = (messages) => {
      const persistable = messages.map(m => ({
        ...m,
        attachments: (m.attachments || []).map(att => ({
          ...att,
          url: att.url && String(att.url).startsWith('blob:') ? undefined : att.url,
        }))
      }));
      localStorage.setItem('palMessages', JSON.stringify(persistable));
    };
    const load = () => {
      const raw = JSON.parse(localStorage.getItem('palMessages') || '[]');
      return raw.map(m => ({
        ...m,
        attachments: (m.attachments || []).map(att => ({
          ...att,
          url: att.url && String(att.url).startsWith('blob:') ? undefined : att.url,
        }))
      }));
    };

    const formatTime = (d = new Date()) => {
      let h = d.getHours();
      const m = d.getMinutes().toString().padStart(2, '0');
      const ampm = h >= 12 ? 'pm' : 'am';
      h = h % 12 || 12;
      return `${h}:${m}${ampm}`;
    };

    const greet = () => {
      const hour = new Date().getHours();
      if (hour < 12) return "Good morning!";
      if (hour < 17) return "Good afternoon!";
      return "Good evening!";
    };

    const palReply = (text) => {
      const t = text.toLowerCase();
      if (t.includes('sales')) return "Your sales are trending up by 8% week-over-week. Would you like a short plan to keep the momentum?";
      if (t.includes('expense') || t.includes('cost')) return "Expenses rose 3% this month, mostly logistics. I can suggest three quick savings tips.";
      if (t.includes('project')) return "You have 4 active projects. The Base App is on track. Want me to set a reminder for the next milestone?";
      if (t.includes('overview') || t.includes('summary')) return "Here’s your overview: sales ₦1.2m, expenses ₦620k, profit ₦580k. Solid work!";
      if (t.includes('hello') || t.includes('hi')) return `${greet()} I'm PAL. How can I help you today?`;
      return "Got it. I’m on it. Do you want a smart alert for this?";
    };

    const render = (messages) => {
      chatEl.innerHTML = '';
      messages.forEach(m => {
        const row = document.createElement('div');
        row.className = `message-row ${m.sender === 'user' ? 'user' : 'pal'}`;

        // Avatars removed per design: no profile pictures in chat

        const bubble = document.createElement('div');
        bubble.className = `message ${m.sender === 'user' ? 'user-message' : 'pal-message'}`;

        if (m.attachments && m.attachments.length) {
          m.attachments.forEach(att => {
            if (att.type === 'doc') {
              const pill = document.createElement('a');
              pill.href = att.url || '#';
              pill.target = '_blank';
              pill.className = 'attachment doc';
              pill.innerHTML = `<span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 3h7l4 4v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z" stroke="currentColor" stroke-width="2"/><path d="M14 3v5h5" stroke="currentColor" stroke-width="2"/><path d="M8 12h8M8 16h6" stroke="currentColor" stroke-width="2"/></svg></span><span>${att.name || 'Document'}</span><span class="text-xs text-gray-500">${att.ext || ''}</span>`;
              bubble.appendChild(pill);
            } else if (att.type === 'image') {
              if (att.url) {
                const img = document.createElement('img');
                img.src = att.url;
                img.alt = att.name || 'Photo';
                bubble.appendChild(img);
              } else {
                const placeholder = document.createElement('div');
                placeholder.className = 'attachment';
                placeholder.innerHTML = '<span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="6" width="16" height="12" rx="2" stroke="currentColor" stroke-width="2"/><circle cx="9" cy="11" r="2" stroke="currentColor" stroke-width="2"/><path d="M20 17l-4-4-3 3-2-2-5 5" stroke="currentColor" stroke-width="2"/></svg></span><span>Photo (preview unavailable)</span>';
                bubble.appendChild(placeholder);
              }
            } else if (att.type === 'audio') {
              if (att.url) {
                const player = document.createElement('div');
                player.className = 'voice-note';

                const playBtn = document.createElement('button');
                playBtn.type = 'button';
                playBtn.className = 'voice-play';
                playBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M8 5l12 7-12 7V5z"/></svg>';

                const progress = document.createElement('div');
                progress.className = 'voice-progress';
                const fill = document.createElement('div');
                fill.className = 'fill';
                progress.appendChild(fill);

                const timeEl = document.createElement('div');
                timeEl.className = 'voice-time';
                timeEl.textContent = '0:00';

                player.appendChild(playBtn);
                player.appendChild(progress);
                player.appendChild(timeEl);
                bubble.appendChild(player);

                const audioObj = new Audio(att.url);
                const fmt = (s) => {
                  const m = Math.floor(s / 60);
                  const sec = Math.floor(s % 60);
                  return `${m}:${sec.toString().padStart(2,'0')}`;
                };
                let isPlaying = false;

                playBtn.addEventListener('click', () => {
                  if (!isPlaying) {
                    audioObj.play();
                    isPlaying = true;
                    playBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M8 5l12 7-12 7V5z"/></svg>';
                  } else {
                    audioObj.pause();
                    isPlaying = false;
                    playBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M8 5l12 7-12 7V5z"/></svg>';
                  }
                });

                audioObj.addEventListener('timeupdate', () => {
                  const dur = audioObj.duration || 0;
                  const pct = dur ? (audioObj.currentTime / dur) * 100 : 0;
                  fill.style.width = `${pct}%`;
                  timeEl.textContent = fmt(audioObj.currentTime);
                });
                audioObj.addEventListener('ended', () => {
                  isPlaying = false;
                  playBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M8 5l12 7-12 7V5z"/></svg>';
                });

                progress.addEventListener('click', (e) => {
                  const rect = progress.getBoundingClientRect();
                  const x = e.clientX - rect.left;
                  const pct = Math.max(0, Math.min(1, x / rect.width));
                  const dur = audioObj.duration || 0;
                  audioObj.currentTime = dur * pct;
                });
              } else {
                const placeholder = document.createElement('div');
                placeholder.className = 'attachment';
                placeholder.innerHTML = '<span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 15a3 3 0 0 0 3-3V8a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3z" stroke="currentColor" stroke-width="2"/><path d="M19 12a7 7 0 0 1-14 0" stroke="currentColor" stroke-width="2"/><path d="M12 19v3" stroke="currentColor" stroke-width="2"/></svg></span><span>Voice note (playback unavailable)</span>';
                bubble.appendChild(placeholder);
              }
            } else if (att.type === 'invoice') {
              if (att.url) {
                const link = document.createElement('a');
                link.href = att.url;
                link.download = att.name || 'invoice.txt';
                link.className = 'attachment doc';
                link.innerHTML = '<span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="3" width="14" height="18" rx="2" stroke="currentColor" stroke-width="2"/><path d="M8 8h8M8 12h8M8 16h6" stroke="currentColor" stroke-width="2"/></svg></span><span>Invoice</span>';
                bubble.appendChild(link);
              } else {
                const placeholder = document.createElement('div');
                placeholder.className = 'attachment doc';
                placeholder.innerHTML = '<span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="3" width="14" height="18" rx="2" stroke="currentColor" stroke-width="2"/><path d="M8 8h8M8 12h8M8 16h6" stroke="currentColor" stroke-width="2"/></svg></span><span>Invoice (download unavailable)</span>';
                bubble.appendChild(placeholder);
              }
            } else if (att.type === 'report') {
              const div = document.createElement('div');
              div.className = 'attachment';
              div.innerHTML = `<span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 18h16" stroke="currentColor" stroke-width="2"/><rect x="6" y="10" width="3" height="6" fill="currentColor"/><rect x="11" y="7" width="3" height="9" fill="currentColor"/><rect x="16" y="12" width="3" height="4" fill="currentColor"/></svg></span><span>${att.text}</span>`;
              bubble.appendChild(div);
            }
          });
          if (m.text) {
            const p = document.createElement('div');
            p.textContent = m.text;
            bubble.appendChild(p);
          }
        } else {
          bubble.textContent = m.text;
        }

        const time = document.createElement('span');
        time.className = 'timestamp';
        time.textContent = m.time || formatTime();

        if (m.sender === 'pal') {
          row.appendChild(bubble);
          row.appendChild(time);
        } else {
          row.appendChild(bubble);
          row.appendChild(time);
        }

        chatEl.appendChild(row);
      });
      chatEl.scrollTop = chatEl.scrollHeight;
    };

    let messages = load();
    if (messages.length === 0) {
      messages = [{ id: Date.now(), sender: 'pal', text: `${greet()} I'm PAL, your AI business partner. Ask me anything.`, time: formatTime() }];
      save(messages);
    }
    render(messages);

    // Header menu and actions
    const newChatBtn = document.getElementById('newChatAction');
    const menuMoreBtn = document.getElementById('menuAction');
    const dropdownEl = document.getElementById('chatMenu');
    const burgerBtn = document.querySelector('.menu-floating');
    const sideMenuEl = document.getElementById('sideMenu');
    const menuOverlayEl = document.getElementById('menuOverlay');
    const chatTitleEl = document.getElementById('chatMenuTitle');

    let chatTitle = localStorage.getItem('chatTitle') || (messages[0]?.text ? messages[0].text.slice(0, 28) : 'Untitled chat');
    chatTitleEl && (chatTitleEl.textContent = chatTitle);

    // New chat clears conversation
    newChatBtn?.addEventListener('click', () => {
      localStorage.removeItem('palMessages');
      messages = [{ id: Date.now(), sender: 'pal', text: `${greet()} I'm PAL, your AI business partner. Ask me anything.`, time: formatTime() }];
      save(messages);
      render(messages);
    });

    // Three-dot dropdown
    menuMoreBtn?.addEventListener('click', () => dropdownEl?.classList.toggle('hidden'));
    document.addEventListener('click', (e) => {
      if (!dropdownEl || dropdownEl.classList.contains('hidden')) return;
      if (e.target.closest('#chatMenu, #menuAction')) return;
      dropdownEl.classList.add('hidden');
    });

    // Dropdown item actions
    dropdownEl?.addEventListener('click', (e) => {
      const item = e.target.closest('.dropdown-item');
      if (!item) return;
      const action = item.dataset.action;
      switch(action) {
        case 'share':
          if (navigator.share) {
            navigator.share({ title: chatTitle, text: 'PAL chat', url: location.href }).catch(()=>{});
          } else { alert('Sharing not supported on this device'); }
          break;
        case 'rename':
          const name = prompt('Rename chat', chatTitle);
          if (name) { chatTitle = name; localStorage.setItem('chatTitle', name); chatTitleEl && (chatTitleEl.textContent = name); }
          break;
        case 'add-to-project':
          alert('Add to project coming soon.');
          break;
        case 'archive':
          localStorage.setItem('palArchived', '1'); alert('Chat archived.');
          break;
        case 'delete':
          if (confirm('Delete this chat?')) {
            localStorage.removeItem('palMessages');
            messages = [];
            render(messages);
            chatTitle = 'Untitled chat';
            localStorage.setItem('chatTitle', chatTitle);
            chatTitleEl && (chatTitleEl.textContent = chatTitle);
          }
          break;
        case 'report':
          alert('Thanks for your report. We will review.');
          break;
      }
    });

    // Side menu open/close
    burgerBtn?.addEventListener('click', () => { sideMenuEl?.classList.remove('hidden'); menuOverlayEl?.classList.remove('hidden'); populateMenu(); });
    menuOverlayEl?.addEventListener('click', () => { sideMenuEl?.classList.add('hidden'); menuOverlayEl?.classList.add('hidden'); });

    // Populate sidebar: credits and recent chats
    function populateMenu() {
      const creditEl = document.getElementById('creditBalance');
      if (creditEl) { creditEl.textContent = isUnlimited() ? '∞' : String(loadCredits()); }

      const recentEl = document.getElementById('recentChats');
      if (recentEl) {
        recentEl.innerHTML = '';
        const title = localStorage.getItem('chatTitle') || 'Untitled chat';
        const item = document.createElement('button');
        item.className = 'menu-item';
        item.textContent = title;
        item.addEventListener('click', () => { sideMenuEl.classList.add('hidden'); menuOverlayEl.classList.add('hidden'); });
        recentEl.appendChild(item);
      }
    }

    document.getElementById('menuNewChat')?.addEventListener('click', () => newChatBtn?.click());
    document.getElementById('menuNewProject')?.addEventListener('click', () => { alert('Create new project coming soon.'); });

    // Negative-space back navigation disabled across screens

    // Actions sheet toggle
    toggleActionsBtn?.addEventListener('click', () => {
      actionsEl.classList.toggle('hidden');
    });

    // Upload handlers
    document.getElementById('action-docs')?.addEventListener('click', () => docInput.click());
    document.getElementById('action-photos')?.addEventListener('click', () => photoInput.click());
    document.getElementById('action-camera')?.addEventListener('click', () => photoInput.click());
    document.getElementById('action-audio')?.addEventListener('click', () => audioInput.click());

    docInput?.addEventListener('change', () => {
      Array.from(docInput.files).forEach(file => {
        const ext = (file.name.split('.').pop() || '').toUpperCase();
        const url = URL.createObjectURL(file);
        messages.push({ id: Date.now()+Math.random(), sender: 'user', text: '', time: formatTime(), attachments: [{ type: 'doc', name: file.name, ext, url }] });
      });
      render(messages); save(messages);
      actionsEl.classList.add('hidden');
      // Background-click back navigation is removed; no state toggle needed.
      localStorage.setItem('palHasDoc', '1');
      streamReply('Thanks, I have received your document. I will analyze it for profitability insights.');
    });

    photoInput?.addEventListener('change', () => {
      Array.from(photoInput.files).forEach(file => {
        const url = URL.createObjectURL(file);
        messages.push({ id: Date.now()+Math.random(), sender: 'user', text: '', time: formatTime(), attachments: [{ type: 'image', name: file.name, url }] });
      });
      render(messages); save(messages);
      actionsEl.classList.add('hidden');
      streamReply('Photo received. I can extract text or analyze quality for branding if you like.');
    });

    audioInput?.addEventListener('change', () => {
      Array.from(audioInput.files).forEach(file => {
        const url = URL.createObjectURL(file);
        messages.push({ id: Date.now()+Math.random(), sender: 'user', text: '', time: formatTime(), attachments: [{ type: 'audio', name: file.name, url }] });
      });
      render(messages); save(messages);
      actionsEl.classList.add('hidden');
      streamReply('Audio uploaded. I can transcribe and summarize key points.');
    });

    // Generate invoice
    document.getElementById('action-invoice')?.addEventListener('click', () => {
      if (!canCharge(25)) {
        alert('Not enough credits to generate invoice. Need 25 credits.');
        streamReply('You have insufficient credits to generate an invoice (need 25).');
        return;
      }
      charge(25);
      const content = `Invoice\nDate: ${new Date().toLocaleDateString()}\nItems: Design Service (₦150,000)\nTaxes: ₦11,250\nTotal: ₦161,250`;
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      messages.push({ id: Date.now()+Math.random(), sender: 'user', text: '', time: formatTime(), attachments: [{ type: 'invoice', name: 'invoice.txt', url }] });
      render(messages); save(messages);
      actionsEl.classList.add('hidden');
      const msg = isUnlimited() ? 'Invoice generated (Unlimited plan: no credits deducted). Tap to download. Want me to email it to your client?' : 'Invoice generated (25 credits deducted). Tap to download. Want me to email it to your client?';
      streamReply(msg);
    });

    // Weekly report
    document.getElementById('action-report')?.addEventListener('click', () => {
      const reportText = 'Weekly Report: sales ₦1.2m, expenses ₦620k, profit ₦580k. 3 tasks due, 1 overdue.';
      messages.push({ id: Date.now()+Math.random(), sender: 'pal', text: '', time: formatTime(), attachments: [{ type: 'report', text: reportText }] });
      render(messages); save(messages);
    });

    // Mic recording (basic)
    micBtn?.addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const recorder = new MediaRecorder(stream);
        const chunks = [];
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
          const blob = new Blob(chunks, { type: 'audio/webm' });
          const url = URL.createObjectURL(blob);
          messages.push({ id: Date.now()+Math.random(), sender: 'user', text: '', time: formatTime(), attachments: [{ type: 'audio', name: 'recording.webm', url }] });
          render(messages); save(messages);
          streamReply('Got your voice note. I can transcribe and draft a response.');
        };
        recorder.start();
        setTimeout(() => recorder.stop(), 3000); // record 3 seconds
      } catch (err) {
        alert('Microphone access denied or unsupported.');
      }
    });

    // Streaming PAL reply like ChatGPT
    function streamReply(text) {
      const typingEl = document.createElement('div');
      typingEl.className = 'message pal-message typing-indicator';
      typingEl.innerHTML = '<span></span><span></span><span></span>';
      chatEl.appendChild(typingEl);
      chatEl.scrollTop = chatEl.scrollHeight;

      setTimeout(() => {
        typingEl.remove();
        const reply = { id: Date.now()+Math.random(), sender: 'pal', text: '', time: formatTime() };
        messages.push(reply);
        let i = 0;
        const interval = setInterval(() => {
          reply.text += text[i] || '';
          render(messages);
          save(messages);
          i++;
          if (i >= text.length) clearInterval(interval);
        }, 20);
      }, 600);
    }

    // Send message
    composerEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = inputEl.value.trim();
      if (!text) return;
      const userMsg = { id: Date.now(), sender: 'user', text, time: formatTime() };
      messages.push(userMsg);
      render(messages);
      save(messages);
      inputEl.value = '';
      actionsEl.classList.add('hidden');

      // Try PAO command handling first
      try {
        const ctx = { projectId: localStorage.getItem('pao_current_project_id') || null };
        if (window.PAO && typeof window.PAO.handleCommand === 'function') {
          const handled = window.PAO.handleCommand(text, ctx);
          const looksLikeCommand = /^(create project|new project)/i.test(text) || /(assign( these)? tasks|show progress|who hasn['’]?t submitted|who has not submitted)/i.test(text);
          if (handled && (handled.data || looksLikeCommand)) {
            if (handled.data && handled.data.project) {
              localStorage.setItem('pao_current_project_id', handled.data.project.id);
            }
            let reply = handled.reply || '';
            if (handled.data && handled.data.tasks && handled.data.tasks.length) {
              const lines = handled.data.tasks.slice(0,6).map(t => `- [${t.status}] ${t.role}: ${t.title}`);
              reply += `\n${lines.join('\n')}`;
              if (handled.data.tasks.length > 6) reply += `\n…and ${handled.data.tasks.length - 6} more tasks.`;
            }
            if (handled.data && handled.data.owners && handled.data.owners.length) {
              reply += `\nPending owners: ${handled.data.owners.map(o=>o.name).join(', ')}.`;
            }
            streamReply(reply);
            return;
          }
        }
      } catch (e) {
        // ignore PAO errors and fall back
      }

      try {
        const res = await fetch('http://localhost:8012/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text })
        });
        const data = await res.json();
        const replyText = data?.reply || palReply(text);
        streamReply(replyText);
      } catch (err) {
        // Fallback to local keyword responder if API fails
        streamReply(palReply(text));
      }
    });
  </script>
</body>
</html>